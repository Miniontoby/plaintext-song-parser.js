{"version":3,"file":"plaintext-song-parser.min.js","sources":["../src/index.ts"],"sourcesContent":["export default class Song {\r\n\tcontent: string = '';\r\n\tidentifier: number|string|null = null;\r\n\ttitle: string|null = null;\r\n\tcouplets: string[][] = [];\r\n\tcoupletsWithReferences: string[][] = [];\r\n\tconstructor(content: string[]|string, identifier: number|string|null = null, title: string|null = null) {\r\n\t\tif (identifier) {\r\n\t\t\tthis.identifier = Number(identifier);\r\n\t\t\tif (isNaN(this.identifier)) this.identifier = identifier;\r\n\t\t}\r\n\t\tif (content && content !== '') {\r\n\t\t\tif (typeof (content) == 'string') this.content = content;\r\n\t\t\telse this.content = content.join('\\n');\r\n\t\t}\r\n\t\tif (title && title !== '') this.title = title;\r\n\t\tif (this.content) {\r\n\t\t\tif (this.title === null) this.title = Song.getTitleFromText(this.getLines(true));\r\n\t\t\tthis.process();\r\n\t\t}\r\n\t}\r\n\tget lines(): string[]|null {\r\n\t\treturn this.getLines();\r\n\t}\r\n\tgetLines(returnComments = false): string[]|null {\r\n\t\tconst allLines = this.content?.split(/\\r?\\n/);\r\n\t\tif (!allLines) return null;\r\n\t\tconst firstNonCommentIndex = allLines.findIndex(line => !line.startsWith('#'));\r\n\t\tif (returnComments) return allLines.slice(0, firstNonCommentIndex);\r\n\t\telse return allLines.slice(firstNonCommentIndex);\r\n\t}\r\n\tprocess(): void {\r\n\t\tif (!this.lines) return;\r\n\r\n\t\tconst paragraphs1 = this.lines.join('\\n').split('\\n\\n'); // split the paragraphs\r\n\t\tlet paragraphs = paragraphs1.map((al) => [al]); // map the paragraphs in seperate arrays\r\n\t\tparagraphs = paragraphs.map((al) => al[0].split('[split]\\n')); // split the paragraphs on the keyword: '[split]'\r\n\t\tconst lastPart = paragraphs[paragraphs.length - 1],lastAl = lastPart[lastPart.length - 1]; // get the last array of the last paragraph\r\n\t\tif (lastAl.endsWith('\\n')) paragraphs[paragraphs.length - 1][lastPart.length - 1] = lastAl.slice(0, -1); // Make sure to remove the linebreak of the last paragraph, else some statements will fail\r\n\t\tconst parts = paragraphs.map((al, i) => {\r\n\t\t\tif (al[0].split('\\n')[0].endsWith(':') && al[0].split('\\n')[0].split(' ').length == 1) return [i, al];\r\n\t\t\treturn null;\r\n\t\t}).filter((x): x is [number, string[]] => x !== null); // filter all paragraphs that end on ':' and that contain no spaces\r\n\t\tconst blockNames = parts.map((al) => [al[0], al[1][0].split('\\n')[0].replace(':', '')]); // get the reference names from the parts array\r\n\t\tconst blockContents = parts.map((al) => { const lines = al[1][0].split('\\n'); lines.splice(0,1); al[1][0] = lines.join('\\n'); return al[1]; }); // get the contents of them, by removing the first line of the paragraph out of the parts array\r\n\t\tconst blocks = blockNames.map((name, i) => [name[0], name[1], blockContents[i]]); // combine the two arrays into 1 array in the format: [id, 'name', 'content']\r\n\t\tlet blockUsage = paragraphs.map((al, i) => {\r\n\t\t\tconst p = al[0].split('\\n');\r\n\t\t\tif (al.length > 1 || p.length > 1) return null;\r\n\t\t\tconst myBlockNames = blockNames.map(a=>a[1]);\r\n\t\t\tif (myBlockNames.includes(p[0]) || myBlockNames.includes(p[0].replace('Repeat ', '')) || myBlockNames.includes(p[0].replace(/\\(([\\w]+)( (\\d+)x|)\\)/, '$1'))) return [i, p[0]];\r\n\t\t\treturn null;\r\n\t\t}).filter((x): x is [number, string] => x !== null); // filter the paragraphs that include an reference to an existing reference\r\n\t\tblockUsage = blockUsage.map((us) => [us[0], us[1].replace('Repeat ', '').replace(/\\((\\w+)( (\\d+)x|)\\)/, '$1$2')]); // Remove 'Repeat ' keyword from the text and the '(key)' and '(key 2x)' keywords\r\n\t\tconst blockUsing = blockUsage.map((us)=>{\r\n\t\t\tconst ourid = us[1].replace(/ (\\d+)x/, '');\r\n\t\t\tconst amount = Number(us[1].replace(/(\\w+)( (\\d+)x|)/, '$3')) || 1;\r\n\t\t\tconst out = blocks.find((bl) => bl[1] == ourid);\r\n\t\t\tif (!out) return;\r\n\t\t\treturn [us[0], ourid, amount, out[2]]; // [index inside paragraphs, blockName, amount of repeats, text]\r\n\t\t}).filter((x): x is [number, string, number, string[]] => x !== null);\r\n\r\n\t\tthis.coupletsWithReferences = JSON.parse(JSON.stringify(paragraphs));\r\n\r\n\t\tfor (const [index, blockName, amount, text] of blockUsing) {\r\n\t\t\tparagraphs[index] = text; // replace the contents of the paragraph with the contents of the reference\r\n\t\t\tfor (let i=1;i<amount;i++) paragraphs[index] = [...paragraphs[index], ...text]; // repeat adding in the contents for the amount\r\n\t\t}\r\n\r\n\t\tthis.couplets = paragraphs;\r\n\t}\r\n\tstatic getTitleFromText(content: string[]|string): string|null {\r\n\t\tconst lines = (typeof (content) == 'string') ? content.split(/\\r?\\n/) : content;\r\n\r\n\t\t// Assuming it is on the first line after an `# ` or `#` -> `# This is the title` or `#This is the title`\r\n\t\tif (lines && lines.length > 0 && lines[0].startsWith('#')) {\r\n\t\t\tif (lines[0].startsWith('# ')) return lines[0].substring(2);\r\n\t\t\treturn lines[0].substring(1);\r\n\t\t}\r\n\t\treturn null;\r\n\t}\r\n}"],"names":["Song","constructor","content","identifier","title","this","couplets","coupletsWithReferences","Number","isNaN","join","getTitleFromText","getLines","process","lines","returnComments","allLines","split","firstNonCommentIndex","findIndex","line","startsWith","slice","paragraphs","map","al","lastPart","length","lastAl","endsWith","parts","i","filter","x","blockNames","replace","blockContents","splice","blocks","name","blockUsage","p","myBlockNames","a","includes","us","blockUsing","ourid","amount","out","find","bl","JSON","parse","stringify","index","blockName","text","substring"],"mappings":"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"}